<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mango Audio Call</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
    body { background:linear-gradient(135deg,#1e1e2f,#2a2a40); color:#fff; min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
    .container { background:rgba(255,255,255,0.05); border-radius:15px; padding:25px; width:100%; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.3); backdrop-filter:blur(10px); }
    .status { text-align:center; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; margin-bottom:20px; font-size:1.2em; }
    .controls { text-align:center; margin:20px 0; display:flex; flex-direction:column; gap:12px; }
    select, button { padding:12px; border:none; border-radius:25px; background:#ff6b6b; color:white; cursor:pointer; transition:0.3s; font-size:1em; }
    select:hover, button:hover { background:#ff8787; transform:translateY(-2px); }
    button:disabled { background:#666; cursor:not-allowed; }
    .chat-section { background:rgba(255,255,255,0.1); border-radius:10px; padding:15px; height:200px; overflow-y:auto; margin:15px 0; }
    .chat-message { margin:5px 0; padding:8px 12px; border-radius:8px; background:#4ecdc4; max-width:80%; word-wrap:break-word; }
    .chat-message.received { background:#45b7d1; margin-left:auto; }
    .input-container { display:flex; gap:10px; }
    #chatInput { flex-grow:1; padding:12px; border:none; border-radius:25px; background:rgba(255,255,255,0.2); color:white; outline:none; }
    #sendButton { padding:12px 20px; border:none; border-radius:25px; background:#ff6b6b; color:white; cursor:pointer; }
    #sendButton:hover { background:#ff8787; }
  </style>
</head>
<body>
  <div class="container">
    <div class="status" id="status">Disconnected</div>

    <div class="controls">
      <select id="userId">
        <option value="">Select Your ID</option>
        <option value="mango1">Mango 1</option>
        <option value="mango2">Mango 2</option>
      </select>
      <button id="startButton">Start Audio Call</button>
      <button id="endButton" disabled>End Call</button>
    </div>

    <div class="chat-section" id="chatBox"></div>
    <div class="input-container">
      <input type="text" id="chatInput" placeholder="Type a message...">
      <button id="sendButton">Send</button>
    </div>
  </div>

  <script>
    // === ELEMENTS ===
    const status = document.getElementById('status');
    const userIdSelect = document.getElementById('userId');
    const startButton = document.getElementById('startButton');
    const endButton = document.getElementById('endButton');
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');

    // === GLOBALS ===
    let localStream = null;
    let peerConnection = null;
    let dataChannel = null;
    let ws = null;
    const signalQueue = [];
    const servers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
      ]
    };

    // === EVENT LISTENERS ===
    startButton.addEventListener('click', startCall);
    endButton.addEventListener('click', endCall);
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    // === WEBSOCKET ===
    function setupWebSocket(userId) {
      if (ws) ws.close();
      ws = new WebSocket('wss://mango2achat.onrender.com'); // CHANGE IF NEEDED

      ws.onopen = () => {
        console.log('WebSocket CONNECTED');
        status.textContent = 'Connected to server';
        sendPendingSignals();
      };

      ws.onmessage = async (event) => {
        try {
          const text = typeof event.data === 'string' ? event.data : await event.data.text();
          const data = JSON.parse(text);

          if (data.sdp && peerConnection) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            console.log('SDP received:', data.sdp.type);

            if (data.sdp.type === 'offer') {
              const answer = await peerConnection.createAnswer();
              await peerConnection.setLocalDescription(answer);
              sendSignal({ sdp: peerConnection.localDescription, from: userId });
              console.log('Answer sent');
            }
          }

          if (data.ice && peerConnection && peerConnection.remoteDescription) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.ice));
            console.log('ICE candidate ADDED');
          }

        } catch (err) {
          console.error('WebSocket error:', err);
        }
      };

      ws.onerror = () => status.textContent = 'Server error';
      ws.onclose = () => {
        if (status.textContent !== 'Disconnected') status.textContent = 'Server disconnected';
      };
    }

    // === SIGNALING ===
    function sendSignal(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
      } else {
        signalQueue.push(data);
      }
    }

    function sendPendingSignals() {
      while (signalQueue.length && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(signalQueue.shift()));
      }
    }

    // === START CALL ===
    async function startCall() {
      const userId = userIdSelect.value;
      if (!userId) { status.textContent = 'Select ID'; return; }

      await endCall();
      startButton.disabled = true;
      endButton.disabled = false;

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        setupWebSocket(userId);
        await new Promise((resolve, reject) => {
          const t = setTimeout(reject, 8000);
          const check = () => {
            if (ws && ws.readyState === WebSocket.OPEN) { clearTimeout(t); resolve(); }
            else setTimeout(check, 100);
          };
          check();
        });

        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

        if (userId === 'mango1') {
          dataChannel = peerConnection.createDataChannel('chat');
          setupDataChannel();
        }
        peerConnection.ondatachannel = e => { dataChannel = e.channel; setupDataChannel(); };

        function setupDataChannel() {
          dataChannel.onopen = () => status.textContent = 'Audio + Chat Active';
          dataChannel.onmessage = e => displayMessage(e.data, 'received');
        }

        peerConnection.ontrack = () => {
          status.textContent = 'Audio Call Active';
        };

        peerConnection.onicecandidate = e => {
          if (e.candidate) {
            console.log('Sending ICE');
            sendSignal({ ice: e.candidate, from: userId });
          }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        sendSignal({ sdp: peerConnection.localDescription, from: userId });

        status.textContent = 'Calling Your Sexy...';

      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        resetButtons();
      }
    }

    // === CHAT ===
    function sendMessage() {
      const msg = chatInput.value.trim();
      if (!msg || !dataChannel || dataChannel.readyState !== 'open') return;
      dataChannel.send(msg);
      displayMessage(msg, 'sent');
      chatInput.value = '';
    }

    function displayMessage(msg, type) {
      const div = document.createElement('div');
      div.className = `chat-message ${type}`;
      div.textContent = msg;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // === END CALL ===
    function endCall() {
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (peerConnection) { peerConnection.close(); peerConnection = null; }
      if (dataChannel) { dataChannel.close(); dataChannel = null; }
      if (ws) { ws.close(); ws = null; }

      signalQueue.length = 0;
      chatBox.innerHTML = '';
      status.textContent = 'Disconnected';
      resetButtons();
    }

    function resetButtons() {
      startButton.disabled = false;
      endButton.disabled = true;
    }
  </script>
</body>
</html>
